name: citest

on:
  push:
    branches:
      - master
      - "release/**"
    paths-ignore:
      - "setup.*"
      - "requirements.txt"
      - "requirements/**"
      - "docs/**"
      - "tools/**"
      - ".scripts/**"
      - "README.md"
      - "README_zh-CN.md"
      - "NOTICE"
      - ".github/workflows/lint.yaml"
      - ".github/workflows/publish.yaml"

  pull_request:
    paths-ignore:
      - "setup.*"
      - "requirements.txt"
      - "requirements/**"
      - "docs/**"
      - "tools/**"
      - ".scripts/**"
      - "README.md"
      - "README_zh-CN.md"
      - "NOTICE"
      - ".github/workflows/lint.yaml"
      - ".github/workflows/publish.yaml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ut-torch180:
    # The type of runner that the job will run on
    runs-on: [unittest-t4]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Run unittest
        id: run_ci_test
        shell: bash
        run: |
          set -e
          UNITTEST_OSS_CONFIG=~/.ossutilconfig.unittest
          if [ ! -e $UNITTEST_OSS_CONFIG ]; then
              echo "$UNITTEST_OSS_CONFIG does not exists"
              exit
          fi

          export OSS_CONFIG_FILE=$UNITTEST_OSS_CONFIG

          export PYTHONPATH=.
          export TEST_DIR="/tmp/easycv_test_${USER}_`date +%s`"

          # do not uncomments, casue faild in Online UT, install requirements by yourself on UT machine
          # pip install -r requirements.txt
          #run test
          export CUDA_VISIBLE_DEVICES=6
          source ~/workspace/anaconda2/etc/profile.d/conda.sh
          conda activate evtorch_torch1.8.0
          PYTHONPATH=. python tests/run.py
      - name: SignalFail
        env:
          CI_TEST_PASSED: ${{steps.run_ci_test.outputs.ci_test_passed}}
        run: |
          echo "CI_TEST_PASSED=${CI_TEST_PASSED}"
          if [ $CI_TEST_PASSED -ne 1 ]
          then
            echo "ci_test_failed, will exit"
            exit 1
          fi
